<div class="card">
  <div class="card-header">
    <div class="date-nav">
      <div class="date-picker">
        <a href="?month={{ prev_month|date:'Y-m' }}" class="date-btn js-ts-month" data-month="{{ prev_month|date:'Y-m' }}" title="Previous month">←</a>
        <div class="date-label">{{ month_name }} {{ current_year }}</div>
        <a href="?month={{ next_month|date:'Y-m' }}" class="date-btn js-ts-month" data-month="{{ next_month|date:'Y-m' }}" title="Next month">→</a>
      </div>
    </div>
    <div style="margin-top: 12px; text-align: center;">
      <button type="button" id="openHowLink" style="width:100%; padding:12px 16px; background:#f8f9fa; border:2px solid #0d6efd; border-radius:8px; font-weight:600; font-size:14px; color:#0d6efd; cursor:pointer; transition: all 0.2s ease; text-align:center;">How does this work?</button>
    </div>
  </div>
  <div class="card-body">
    <div class="calendar-scroll">
    <div class="calendar-grid">
      <div class="row g-0 calendar-header">
        <div class="col text-center fw-bold">Mon</div>
        <div class="col text-center fw-bold">Tue</div>
        <div class="col text-center fw-bold">Wed</div>
        <div class="col text-center fw-bold">Thu</div>
        <div class="col text-center fw-bold">Fri</div>
        <div class="col text-center fw-bold">Sat</div>
        <div class="col text-center fw-bold">Sun</div>
      </div>
      {% for day_data in calendar_data %}
        {% if forloop.counter0|divisibleby:7 %}<div class="row g-0 calendar-week">{% endif %}
        <div class="col calendar-day 
            {% if not day_data.is_current_month %}calendar-day-other{% endif %}
            {% if day_data.is_today %}calendar-day-today{% endif %}"
            {% if day_data.is_current_month %}
              data-date="{{ day_data.date_str }}"
              data-weekday="{{ day_data.weekday }}"
              data-current-tag="{{ day_data.tag_id }}"
              onclick="openDayModal(event, '{{ day_data.date_str }}', '{{ day_data.weekday }}', '{{ day_data.tag_id }}')"
            {% endif %}>
            {% if day_data.is_current_month %}
            <div class="d-flex justify-content-between align-items-start">
              <div class="day-number">{{ day_data.day }}</div>
              <div class="day-tag">
                {% if day_data.tag_id %}
                  <span class="badge" style="background-color: {{ day_data.tag_color }}; color: #fff;">{{ day_data.tag_name }}</span>
                {% else %}
                  <span class="badge bg-light text-dark">—</span>
                {% endif %}
              </div>
            </div>
            {% if day_data.avg_score %}
              <div class="d-flex justify-content-center mt-2">
                {% with status_class="" %}
                  {% if day_data.range_min and day_data.range_max %}
                    {% if day_data.avg_score < day_data.range_min %}
                      {% with status_class="below" %}{% endwith %}
                    {% elif day_data.avg_score > day_data.range_max %}
                      {% with status_class="above" %}{% endwith %}
                    {% else %}
                      {% with status_class="in-range" %}{% endwith %}
                    {% endif %}
                  {% endif %}
                {% endwith %}
                <div class="ts-progress"
                     data-score="{{ day_data.avg_score }}">
                  <svg viewBox="0 0 100 100">
                    <circle class="background-circle" cx="50" cy="50" r="35"></circle>
                    <circle class="progress-circle {% if day_data.range_min and day_data.range_max %}{% if day_data.avg_score < day_data.range_min %}below{% elif day_data.avg_score > day_data.range_max %}above{% else %}in-range{% endif %}{% else %}neutral{% endif %}"
                            cx="50" cy="50" r="35"
                            stroke-dasharray="0 219.9"
                            stroke-dashoffset="0"></circle>
                  </svg>
                  <div class="score-text">{{ day_data.avg_score }}</div>
                </div>
              </div>
            {% endif %}
            {% endif %}
        </div>
        {% if forloop.counter|divisibleby:7 or forloop.last %}</div>{% endif %}
      {% endfor %}
    </div>
    </div>

    <div class="mt-4">
      <h6>Quick Actions</h6>
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copyLastMonth()">Copy Last Month</button>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearCurrentMonth()">Clear All Tags</button>
      </div>
    </div>
  </div>
</div>

