{% extends 'base.html' %}
{% load core_extras %}

{% block title %}Get Started - Step 4{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Progress Indicator -->
            <div class="text-center mb-4">
                <div class="progress mb-2" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <small class="text-muted">Step {{ current_step }} of {{ total_steps }}</small>
            </div>

            <!-- Skip Tutorial Link -->
            <div class="text-end mb-3">
                <a href="{% url 'core:get_started' %}?skip=true" class="text-muted text-decoration-none">
                    Skip Tutorial <i class="bi bi-arrow-right"></i>
                </a>
            </div>

            <!-- Main Content -->
            <div class="card shadow mb-4">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-center mb-4">
                        <i class="bi bi-calendar-event text-primary me-3" style="font-size: 2.5rem;"></i>
                        <h2 class="card-title mb-0">Set Up Your Schedule</h2>
                    </div>

                    <!-- Explanation -->
                    <div class="mb-4">
                        <div class="alert alert-light border">
                            <h6 class="alert-heading mb-3">How the Schedule Works</h6>
                            <ul class="mb-0 ps-3">
                                <li class="mb-2">Click any day in the calendar to assign a tag (Training, Matches, etc.)</li>
                                <li class="mb-2">Each day's tag sets the target readiness range for that specific day</li>
                                <li class="mb-2">The dashboard will highlight athletes who fall outside the expected range for each day type</li>
                                <li>You can set weekly patterns or customize individual dates - useful for match days, training camps, or recovery periods</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="card shadow">
                <div id="calendar-container" class="fade-container" data-current-month="{{ current_year }}-{{ current_month|stringformat:'02d' }}">
                    {% include 'core/get_started_step4_calendar.html' %}
                </div>
            </div>

            <!-- Navigation -->
            <div class="d-flex justify-content-between mt-4">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="back">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                </form>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="next">
                    <button type="submit" class="btn btn-primary">
                        Continue <i class="bi bi-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Day Selection Modal (simplified for tutorial) -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-animate-from">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Day Type â€” <span id="modalWeekday"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    {% for tag in day_tags %}
                    <button type="button" class="list-group-item list-group-item-action day-tag-option" 
                            data-tag="{{ tag.id }}" data-name="{{ tag.name }}" data-color="{{ tag.color }}" data-date="">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge" style="background-color: {{ tag.color }}; color:#fff;">{{ tag.name }}</span>
                            <small class="text-muted">Range: {{ tag.target_min }}-{{ tag.target_max }}%</small>
                        </div>
                    </button>
                    {% endfor %}
                    <button type="button" class="list-group-item list-group-item-action day-tag-option" 
                            data-tag="" data-name="" data-color="" data-date="">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary">Clear Tag</span>
                        </div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<style>
.date-nav { display:flex; justify-content:center; width:100%; margin-bottom: 10px; }
.date-picker { display:flex; align-items:center; background:#ffffff; border:2px solid #e0e0e0; border-radius:50px; padding:6px 12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; max-width: 320px; width: 100%; position: relative; }
.date-picker:hover { border-color:#007bff; box-shadow:0 4px 12px rgba(0,123,255,0.15); transform: translateY(-1px); }
.date-picker:focus-within { border-color:#007bff; box-shadow:0 0 0 3px rgba(0,123,255,0.1); }
.date-btn { background:none; border:none; padding:10px; cursor:pointer; border-radius:50%; display:flex; align-items:center; justify-content:center; transition: all 0.2s ease; color:#666; font-size:16px; min-width:40px; min-height:40px; }
.date-btn:hover { background:#f8f9fa; color:#007bff; transform: scale(1.1); }
.date-label { font-size:16px; font-weight:600; color:#333; text-align:center; flex:1; padding:0 12px; white-space:nowrap; }
.calendar-grid {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    overflow: hidden;
}
.calendar-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0.5rem 0;
    display: flex;
    flex-wrap: nowrap;
}
.calendar-week {
    border-bottom: 1px solid #dee2e6;
    display: flex;
    flex-wrap: nowrap;
}
.calendar-week:last-child {
    border-bottom: none;
}
.fade-container {
    transition: opacity 0.2s ease;
}
.calendar-day {
    min-height: 80px;
    padding: 0.5rem;
    border-right: 1px solid #dee2e6;
    cursor: pointer;
    transition: background-color 0.2s;
    flex: 0 0 14.2857%;
    max-width: 14.2857%;
}
.calendar-day:last-child {
    border-right: none;
}
.calendar-day:hover {
    background-color: #f8f9fa;
}
.calendar-day-other {
    background-color: #f8f9fa;
    cursor: default;
}
.calendar-day-today {
    background-color: #e3f2fd;
    border: 2px solid #2196f3;
}
.day-number {
    font-weight: bold;
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
}
.day-tag {
    font-size: 0.7rem;
}
.day-tag .badge {
    opacity: 0.7;
    font-size: 0.65rem;
    padding: 0.25rem 0.4rem;
}
.day-tag-option:hover {
    background-color: #f8f9fa;
}
.day-tag-option.active {
    background-color: #e3f2fd;
    border-color: #2196f3;
}
@media (max-width: 576px) {
  .calendar-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .calendar-grid { min-width: 680px; }
  .calendar-day { min-height: 64px; padding: 0.35rem; }
  .day-number { font-size: 0.7rem; }
  .day-tag .badge { font-size: 0.6rem; padding: 0.18rem 0.35rem; }
}
</style>

<script>
// Smooth month navigation for Step 4 calendar
document.addEventListener('DOMContentLoaded', function(){
  const container = document.getElementById('calendar-container');
  
  function loadCalendarMonth(month){
    container.style.opacity = 0.4;
    fetch('{% url "core:get_started" step=4 %}?partial=month&month=' + month, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}'
      }
    })
      .then(r=>r.json())
      .then(data=>{
        if(!data.success) {
          container.style.opacity = 1;
          return;
        }
        container.innerHTML = data.html;
        container.setAttribute('data-current-month', month); // Store current month
        container.style.opacity = 1;
        bindMonthNav();
        bindDayClicks();
      })
      .catch(()=>{ container.style.opacity = 1; });
  }
  
  function bindMonthNav(){
    document.querySelectorAll('.js-ts-month').forEach(function(a){
      a.addEventListener('click', function(e){
        e.preventDefault();
        const month = this.getAttribute('data-month');
        loadCalendarMonth(month);
      });
    });
  }
  
  function bindDayClicks(){
    document.querySelectorAll('.calendar-day[data-date]').forEach(function(day){
      day.addEventListener('click', function(e){
        const dateStr = this.getAttribute('data-date');
        const weekday = this.getAttribute('data-weekday');
        const currentTag = this.getAttribute('data-current-tag');
        openDayModal(e, dateStr, weekday, currentTag);
      });
    });
  }
  
  bindMonthNav();
  bindDayClicks();
  
  // Expose functions globally for use in day modal handler
  window.bindDayClicks = bindDayClicks;
  window.loadCalendarMonth = loadCalendarMonth;
});

function openDayModal(evt, dateStr, weekday, currentTag) {
    const dayNum = parseInt((dateStr || '').split('-')[2], 10);
    const compact = isNaN(dayNum) ? weekday : `${weekday} ${dayNum}`;
    document.getElementById('modalWeekday').textContent = compact;
    
    document.querySelectorAll('.day-tag-option').forEach(option => {
        option.dataset.date = dateStr;
        option.classList.remove('active');
        if (option.dataset.tag === currentTag) {
            option.classList.add('active');
        }
    });
    
    const modal = new bootstrap.Modal(document.getElementById('dayModal'));
    modal.show();
}

document.querySelectorAll('.day-tag-option').forEach(option => {
    option.addEventListener('click', function() {
        const tag = this.dataset.tag;
        const tagName = this.dataset.name;
        const tagColor = this.dataset.color;
        const date = this.dataset.date;
        
        fetch('{% url "core:team_schedule_settings" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '{{ csrf_token }}'
            },
            body: JSON.stringify({
                date: date,
                day_tag: tag
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('dayModal')).hide();
                // Reload calendar to show updated tag - preserve current month
                if (window.loadCalendarMonth) {
                  // Get current month from container or date we just updated
                  const container = document.getElementById('calendar-container');
                  let month = container ? container.getAttribute('data-current-month') : null;
                  if (!month) {
                    // Try to get from the date we just updated
                    const dateParts = date.split('-');
                    if (dateParts.length === 3) {
                      month = `${dateParts[0]}-${dateParts[1]}`;
                    } else {
                      // Fallback to current month
                      const currentDate = new Date();
                      month = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                    }
                  }
                  window.loadCalendarMonth(month);
                } else {
                  location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
